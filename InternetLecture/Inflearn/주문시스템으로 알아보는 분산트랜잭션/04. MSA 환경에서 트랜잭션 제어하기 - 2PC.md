# 14. 2PC란 무엇인가?
- Two-Phase Commit Protocol
- 분산 시스템에서 트랜잭션의 원자성 보장
- 트랜잭션을 두 단계로 나누어 처리한다.
  - 각 단계는 Prepare과 Commit으로 구성되어 있으며, 모든 서버가 Prepare을 성공해야 Commit이 가능하다.
  - Prepare 단계
    - 트랜잭션 매니저가 참여자에게 작업 준비가 가능한지 묻는다.
  - Commit 단계
    - Commit 단계: Prepare 단계에서 모든 참여자가 작업 가능 응답시 실제로 커밋을 수행한다.
- 대표적인 구현 -> XA 트랜잭션 (?)
- 실습
  - 실습 환경 
    - 터미널 3개
    - 터미널1
      - create database 2pc1;
      - use 2pc1;
      - create table product ( id int primary key, quantity int );
      - insert into product values (1, 1000);
    - 터미널2
      - create database 2pc2;
      - use 2pc2;
      - create table point ( id int primary key, amount int );
    - 터미널3
  - 터미널1
    - xa start 'product_1';
    - update product set quantity = 900 where id = 1;
    - xa end 'product_1';
  - 터미널2
    - xa start 'point_1';
    - insert into point values (1, 1000);
    - xa end 'point_1';
  - 터미널3
    - update product set quantity = 800 where id = 1;
  - 터미널1
    - xa prepare 'product_1';
  - 터미널2
    - xa prepare 'point_1';
  - 터미널1
      - xa commit 'product_1'; (터미널 3에서 업데이트가 이후 실행된다.)
  - 터미널2
      - xa commit 'point_1';
- 2PC 장/단점
  - 장점
    - 강력한 적합성 보장
    - XA를 지원한다면 구현 난이도가 낮다.
  - 단점
    - XA를 지원하지 않는 경우 구현 난이도가 높다.
    - prepare ~ commit 완료까지 lock 유지 -> 가용성 낮다.
    - 장애 복구시 수동 개입 해결 필요
    - 실용성이 낮다.
  - 결론
    - 2PC 보다는 다른 방법 사용하여 분산 트랜잭션 구현
