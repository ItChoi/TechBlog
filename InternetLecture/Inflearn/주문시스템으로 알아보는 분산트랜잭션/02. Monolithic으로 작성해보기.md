# 3. 소스코드
- [git hub](https://github.com/sangyongchoi/distributed-transaction)
---
# 4. 프로젝트 세팅
- Spring Initializer 사용
1. https://start.spring.io/
2. 의존성 선택
3. Generate
4. Project Open
- 프로젝트 생성 완료 후
  - src 폴더 삭제 -> 여기서 개발 X
  - 모듈 하나 생성
# 5. 요구사항 정의
- 주문 데이터 저장
- 재고 관리 필요
- 포인트 사용
- 주문, 재고, 포인트 데이터 정합성
- 동일 주문 불가능 -> 주문은 1회만
---
# 6. 간단한 재고관리 로직 구현해보기
- 구조
  - init
    - TestDataCreator.class
  - product
    - controller
      - controller.class
      - dto
        - request.class
    - application
      - dto
        - xxxCommand.class
      - service
        - service.class
    - domain
      - domain.class
    - infrastructure
      - repository.class
---
# 7. 간단한 포인트관리 로직 작성해보기
---
# 8. 간단한 주문로직 작성해보기
---
# 9. Transaction을 사용하여 정합성 보장하기
- order 저장 -> product 저장 -> point 저장
  - 정합성이 맞는다.
  - 중간에 오류 발생하면?
- 해결 방법
  - Mysql Transaction
    - Atomicity (원자성)
    - Consistency (일관성)
    - Isolation (격리성)
    - Durability (지속성)
    - ACID를 보장한다. 
    - 원자성을 이용한 정합성 보장
      - 전부다 성공 또는 전부 실패를 보장
      - 소스 코드 내 메소드에 @Transaction 추가.
---
# 10. 동일한 주문인지 알 수 있도록 주문로직 수정하기
- 터미널을 활용해 두 개 요청
```shell
curl -X POST http://localhost:8080/order/place \
  -H "Content-Type: application/json" \
  -d '{
    "orderItems": [
      {"productId": 1, "quantity": 1},
      {"productId": 2, "quantity": 2}
    ]
  }'
```
- 장바구니, 결제 페이지 분리
  - 장바구니 -> 수량 변경 가능 -> 주문하기 버튼 -> 결제 페이지 (수정 불가) -> 결제하기 -> 결제, 주문 진행
  1. 주문하기 요청 -> 주문 생성, 주문 아이템 정보 저장 -> 생성된 주문 id 반환
  2. 결제하기 요청 (with 주문 id) -> 재고 차감, 포인트 사용 -> 결과 반환
```shell
curl -X POST http://localhost:8080/order/place \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": 1
  }'
```
# 11. Lock을 활용하여 주문로직이 1번만 수행되도록 변경하기
- 여러 개 요청이 동시에 로직을 수행할 수 있다.
  - 요청1 수행 중, 요청2가 들어올 수 있다. (요청1 주문 완료 상태 아니라 가능)
  - 요청1이 수행 중, 요청 2가 들어오지 못하도록!
- 레디스 활용한 Lock을 통해 문제 해결을 해보자.
  1. 요청1 주문 요청 -> 요청1 Lock 점유(레디스)
  2. 요청2 주문 요청 -> 요청1 로직 수행 중 -> 요청2 Lock 점유 시도 -> 불가
  3. 요청1 Lock 해제
- 레디스 세팅
  - docker pull redis
  - docker run --name myredis -d -p 6379:6379 redis
  - docker exec -it myredis redis-cli
  - setnx test1 1 -> 1 반환
  - setnx test1 1 -> 0 반환 (점유중)
  - 주의 -> TTL(만료시간) 반드시 필요, 없을시 데드락이 된다.
    - SET key value NX PX ttl
      - SET lock:order:123 <uuid> NX PX 30000
      - NX: 없을 때만 set
      - PX 30000: 30초 TTL (밀리초)
      - 성공시 "OK", 실패시 (nil)
      - SETNX + EXPIRE 따로 하는 것 보다 안전 -> 중간 장애시 TTL이 안 걸릴 수 있다.
      - value는 고유값 추천 -> 해제시 내가 잡은 락인지 체크 필요!
      - DEL lock:order:123
        - 금지 -> 내가 잡은 Lock이 아닌데 지워질 수 있다.


