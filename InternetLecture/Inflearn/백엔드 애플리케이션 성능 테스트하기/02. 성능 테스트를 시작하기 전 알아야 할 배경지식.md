# 목차
1. 지연시간(Latency)과 처리량(Throughput)
2. 운영체제와 서버 자원
3. 네트워크
4. 데이터베이스
5. 스레드 풀과 커넥션 풀
6. 성능 테스트의 방향성

---

# 지연시간(Latency)과 처리량(Throughput)
- 성능 테스트 시작 전 알아야할 배경 지식 (중요)
1. 지연시간 (Latency)
   - 요청 건 당 처리 시간
   - 요청을 보내 응답을 받을 때 까지의 시간
   - 주로 ms, s 단위
   - 이용자의 중요한 성능 지표
   - 도메인에 따라 지연 시간의 이용자 지연시간 기대치가 다를 수 있다.
     - 인강 페이지
     - 항공권 비교 검색 서비스 
2. 처리량 (Throughput)
   - 일정 시간 동안 몇 건을 처리 할 수 있는 양
   - TPS: Transaction Per Second 단위를 많이 사용한다.
   - TPS 1000을 무리 없이 처리 가능 -> API 처리량은 1000TPS 이상이라 표현할 수 있다.
   - 데이터 전송량
   - 원래는 네트워크 용어
3. 대역폭 (Bandwith)
   - 네트워크 용어
   - 네트워크가 단위시간동안 전송할 수 있는 최대 처리량을 의미한다.
- 처리량과 지연시간에만 집중해보자.
- 성능 측정 예시
  - 초당 3000개 요청(처리량) -> 99% 요청이 100ms 미만(지연시간) 처리돼야 함
    - 지연시간 + 처리량을 결합해 성능 테스트 목표를 세운다.
    - 예상 이용자 + 예상 API 몇 건 -> 어느 정도 지연시간 미만이어야 불편하지 않은지 체크
    - 예상 이용자, 수용 가능 지연시간
  
# 운영체제와 서버 자원
- 운영체제
  - 컴퓨터의 물리적인 자원 관리, 필요한 곳에 할당하여 앱 실행에 도움을 준다.
  - 일반적인 서버 운영체제 -> 리눅스
  - 앱 
    - 프로세스 - CPU, RAM, DISK 필요
    - 작업에 따라 CPU 또는 메모리, 디스크를 많이 사용 할 수 있다.
    - 유한한 자원 -> 다른 자원이 여유가 있더라도 지연 시간이 발생 할 수 있다.
      - 병목을 낮추는 방법이 필요하다.
      - 효과적인 성능 테스트 및 개선 -> 서버 모니터링 필수
  - 프로그램 -> 프로세스 -> 실행
    - 프로그램: 가상 메모리
    - 프로세스: 메모리 + 코드
    - CPU 실행 -> 프로세스 코드에 변수를 넣거나 가져와서 사용한다., 메모리를 읽으며 프로세스와 CPU는 상호작용한다.
    - 가상 메모리 사용시 -> 물리 메모리를 디스크에 저장하고 불러오고 하는 페이징을 한다.
    - 프로세스, 프로그램, CPU 모두 상호작용!
  - CPU
    - 계산, 이미지 또는 영상 인코딩, 암호화, 캐시화
  - 램
    - CPU를 많이 쓰는 경우 함께 쓰이는 경우가 많다, 인스턴스 대량 생성, 캐싱, 컬렉션 객체 등
  - 디스크
    - 파일 입출력, 로그 대량 발생시 사용, DB IO
- 처리량 증가 -> 서버 자원 사용량 증가 -> 프로세스, 스레드 자원 사용을 위한 대기 시간 증가(경쟁 상태 -> 처리량 낮아진다.) -> 지연시간 길어짐 -> 요청이 쌓임 -> 일부 요청 실패
  
# 네트워크
- 네트워크
  - 다른 서버 자원 사용시 네트워크 I/O 필요
- 성능 테스트에서 네트워크 비중이 크다.
  - 개선 포인트를 잘 잡아야 한다.
- 클라이언트 요청, 응답
  - 지연 시간
  - 클라이언트 -> API -> DB, 다른 API 호출 등
    - DB, 다른 서버 호출은 네트워크 통신 발생이다.
    - 네트워크 통신은 자원 사용이 크다.
      - 대부분 1ms를 넘긴다. 내부 API 로직은 대부분 1ms 이내
      - 성능 테스트시 네트워크 부분 반드시 이해 필요
      - 클라이언트 지연시간 줄이기 -> 네트워크 성능 테스트 가능한지 인지 체크 필요
        - 캐시 활용
        - DB 성능 개선
- 네트워크는 마법이 아니다.
  - 물리적인 거리에 제약을 굉장히 받는다.
  - 우리나라 -> 우루과이 API 요청
    - 우루과이까지 갔다가 우리나라로 되돌아온다 -> 시간이 더 걸린다.
    - 당연히 라우터들은 직선이 아니다. -> 처리 시간 추가
- ping 테스트
  - ping opcion.com.uy
    - 134ms
  - ping inflearn.com
    - 3ms
  - 물리적인 거리가 매우 중요하다.
    - 같은 IDC -> 1ms 이내 가능
      - 물리적으로 떨어져 있는 경우, 100배 이상 지연 발생 가능
- 네트워크 대역폭과 지연시간의 관계
  - 대역폭 100mb/s 네트워크 회선 -> 클라이언트가 100mb 모두 사용 중, 다른 클라이언트가 50bm/s 추가로 보낼 시 -> 50mb/s는 보내지지 않고, 버퍼링되거나 클라이언트에 쌓인다.
  1. 대용량 파일 다운로드와 웹 서핑 같이 사용시 -> 웹 페이지 로딩시 지연 발생
  2. 고해상도 이미지 웹 접속 -> 이미지 느리게 로딩
  - 모두 대역폭이 사용되면 지연시간이 생긴다
  
# 데이터베이스
- DB도 운영체제에 의해 실행되는 프로세스 (앱)
  - DISK
    - DB 저장
  - 메모리
    - 데이터를 연산 할 수 있도록 캐싱
  - CPU
    - 이용자가 원하는 데이터인지 체크
- DB 지연시간 길어지는 상황
  - 짧은 시간 많은 요청이 필요한 경우 (처리량이 큰 경우)
  - 저장된 데이터가 많은 저장소에서 데이터를 찾는 경우 -> 인덱스 생성 필요
  - 한 번에 많은 데이터를 반환할 경우
    - 메모리에 올리는 비용
    - 서버 - 네트워크 대역폭 전송 비용
  - 트랜잭션 지원을 위한 데이터 락이 필요 이상 발생하는 경우
    - 스레드 점유시 다른 스레드의 접근을 막는다.
    - 데드락 발생으로 인한 응답 처리 불가 상태
- 처리 속도 우선순위
  - CPU
  - RAM
  - DISK
- 서로 다른 IDC 데이터베이스 이중화
  - 안정적 운행을 위한 이중화
  - 동기화 필요
  - 서로 다른 IDC 위치 할 때 전용회선을 구성하기도 한다.
    - 다른 서버간 대역폭에 영향을 주지 않고, 안전하고 빠르게 대용량 교환 가능
  
# 스레드 풀과 커넥션 풀
- 별도 설저 없이 디폴트 생성 숫자가 정해져 있다.
  - 성능 테스트시 튜닝 필요
  - 문제 발생시 체크 필요
- 데드락 발생시..
  - 락 -> 데드락 발생
    - 서버 자원 고갈 -> 성능 악영향
    - 대기중 상태 유지 -> 서버 자원 사용하지 않지만 대기 시간이 길어진다.
- 스레드 풀
  - 톰캣 -> 스레드 디폴트 200개
    - 처리시 사용, 사용후 반납 = 재사용 개념(pool)
  - 모든 스레드 사용 
    - 일부 요청 -> Que 저장 -> 스레드 사용 환경 될 경우 사용
    - 모든 스레드 사용 + 큐 꽉 참 -> 일부 요청 버려짐 현상
    - 무작정 스레드 생성 X -> 너무 많은 자원 사용 -> 서버 자원 많이 필요..
      - LB -> 요청 분리로 개선 또는 비동기 처리 변경 필요
        - 해결책이 안 될 수도 있다.
        - 인프라 요소 부하 -> 전체 앱 성능이 느려질 수 있다 (병목)
      - 병목 개선 또는 설계 변경 필요
- 커넥션 풀
  - 처리량 많을 수록 커넥션 풀 빠르게 고갈
  - DB 커넥션 수 제어 -> 지나친 경쟁 상황 피할 필요가 있다.
- 스레드 풀, 커넥션 풀은 성능 테스트를 통해 적절한 개수를 지정하는 것이 중요하다.
  
# 성능 테스트의 방향성
- 실무, 토이 성능 테스트 -> 인프라 구성 차이점, 개선 목표도 다르다.
- 실무: 
  - TPS 지연 시간 몇 ms 유지 등의 목표
  - 튜닝 및 인프라 자원 필요
- 토이
  - 한 건 씩 지연 시간 체크
  - 점진적 처리량 수를 늘려 지연시간 치솟는 구간 찾기
  - 테스트 반복 -> 성능 병목 체크 
    - 가설 세우기 -> 너무 많은 영역에 대한 고민...
      - 체크 -> 모니터링, 로그 등을 통해 병목 지점 탐색
  - 병목 해결 방법 적용
    - 인덱스 생성
    - 시스템 설계 변경
    - 인프라 구성 
    - 등등등...
