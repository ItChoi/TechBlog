# 섹션 5. [기초편] 컨트롤러

## DaemonSet, Job, CronJob
- Controller - DaemonSet
  - 레플리카셋 -> 스케줄러에 의해 노드 안에 파드를 배치할 때, 노드 자원 상황에 따라 파드를 적절히 배치한다.
  - 데몬셋은 노드 자원 상태랑 상관없이 모든 노드에 파드가 하나씩 생긴다는 것이 특징이다.
    - 성능 수집 -> Prometheus, ... (모든 노드 정보 수집 -> 시스템 전달)
    - 로그 수집 -> fluentd, ... (특정 노드 장애 발생 -> 모든 노드 로그 정보 수집)
    - 노드 스토리지 활용 -> GlusterFS, ... (노드들을 스토리지에 활용, 각각의 노드에 설치 -> 해당 자원으로 NFS 구축 가능)
      - k8s 자체도 네트워킹 관리를 위해 각 노드에 데몬셋프록시 역할 파드 생성 후 관리
- Controller - Job
  - Job을 통해 파드를 만들 수 있다.
    - 파드는 직접 생성, ReplicaSet, Job 등을 통해 생성 될 수 있다. (파드 생성 주체에 따라 파드 동작이 다르다.)
      - 직접 생성: 노드 다운 -> 파드 서비스 유지 X
      - ReplicaSet: 노드 다운 -> 컨트롤러에 의해 장애 감지 -> 다른 노드에 파드 재생성 (Restart) (서비스 유지 목적) 
      - Job: 노드 다운 -> 컨트롤러에 의해 장애 감지 -> 다른 노드에 파드 재생성 (Finish) -> 파드 삭제는 아니고 파드 정지 상태
- Controller - CronJob
  - Job을 주기적으로 생성하는 역할
  - Job 하나를 만들어 쓰진 않고, CronJob을 만들어 사용
  - 유즈 케이스
    - Backup -> 매일 새벽 DB 백업
    - Checking -> 주기적인 업데이트
    - Messaing -> 메시지 발송 등
    - 등등등
---
- Controller - DaemonSet
  - yml 설정
    - selector
      - Label로 노드-데몬셋 연결
    - template
      - 모든 노드에 템플릿으로 파드 생성
      - nodeSelector: 지정하여 이 라벨이 없는 노드에는 파드가 생성되지 않는다.
  - 특정 노드 파드 접근
    - externalTrafficPolicy: Local -> 특정 노드에 노드 포트 접근 -> 트래픽은 서비스로 이동 -> 파드 접근
    - hostPort -> 직접 노드에 있는 포트가 파드와 연결, 위와 동일
      - hostPort: 18080, containerPort: 8080 -> 18080 포트 트래픽이 8080 컨테이너 포트로 연결된다.
- Controller - Job
  - yml 설정
    - selector
      - 직접 만들지 않아도, Job이 알아서 만들어 준다.
    - template
      - 특정 작업 후 종료되는 파드
    - completions: 6
      - 6개의 파드를 하나씩 순차적으로 실행 후 순차적 종료 후 Job 종료
    - parallelism: 2
      - 2개씩 파드가 생성
    - activeDeadlineSeconds: 30
      - Job이 30초 후 기능 정지, 실행 중인 모든 파드 삭제, 실행 중이지 않은 파드도
      - 10초 걸릴 일인데 30초가 되도 작업이 끝나지 않은 경우 사용
    - restartPolicy: Never
      - 픽스 값, Job의 경우 네버, 온페일러만 사용 가능
- Controller - CronJob
  - yml 설정
    - jobTemplate
      - 이 내용 기반으로 Job 생성
      - suspend: Job 일시 정지 기능
      - ManualTrigger
    - schedule
      - 이 크론 포맷으로 주기 관리
    - concurrencyPolicy
      - 1분 주기 설정이라고 가정
      - Allow (default)
        - 1분 간격으로 Job 생성 -> 파드 생성, 2분에 파드 상태와 상관없이 순환하며 새로 생성
      - Forbid
        - 1분에 Job 생성, 2분에 첫 Job의 Pod가 종료되지 않으면 2분에 생겨야 되는 Job은 스킵
        - 파드 종료가 되는 즉시 Job -> pod 만들어지는 구조
      - Replace
        - 1분에 Job 생성, 2분에 파드가 러닝 중인 상태라면, 새로운 파드를 만들어 교체
        - 새로운 Job은 생기지 않고, 새로운 파드가 만들어지면서 연결
        - Job 종료시 새로운 Job, Pod 생성
