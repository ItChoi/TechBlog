# 섹션 7. [중급편] 기본 오브젝트

## Service - Headless, Endpoint, ExternalName
- 초급편 서비스 상세 정의
  - Internet Network
    - 공유기(192.168.0.1) 
      - 내부망 형성
        - Master (192.168.0.30)
        - node1  (192.168.0.31)
        - node2  (192.168.0.32)
  - k8s Cluster
    - 마스터와 노드로 K8s 클러스터가 만들어진다.
      - 클러스터 내부
        - 파드를 위한 IP 대역  (20.96.0.0/12) - K8s 구성시 대역 설정 가능
          - 파드 생성시 20번대 ip 할당
        - 서비스를 위한 IP 대역 (10.96.0.0/12) - K8s 구성시 대역 설정 가능
          - 서비스 생성시 10번대 ip 할당
        - 서비스 - 파드 (라벨 매핑) 연결
        - Cluster IP 서비스
          - k8s 구성 서버에서만 호출 가능 (master, node1, node2)
  - 내부망 IP 할당 기기 (PC, desktop, laptop, ...)
    - ClusterIP 서비스를 ip로 직접 호출 불가
    - 내부망 다른 서버가 접근하기 위해 NodePort 서비스 구성! (30000)
      - k8s 구성 서버에 30000 port가 생성되어 해당 서비스와 연결된다.
        - 내부망 기기는 서버 중 하나의 IP(master, node1, node2)와 port(30000)를 알려준다. -> 서비스 간접 접근 가능
  - Cloud Provider(GCP, AWS, Azure) 사용한 k8s 클러스터 구축
    - k8s 로드밸런스 타입의 NodePort 서비스 구성!(30001)
      - 외부망 기기는 서버 중 하나의 IP(master, node1, node2)와 port(30001)를 알려준다. -> 서비스 간접 접근 가능
  - 사용자 관점 k8s 망에 있는 서비스, 연결된 파드에 접근 서비스 구성 (서비스 타입)
    1. ClusterIP (Admin)
    2. NodePort (Internal User)
    3. LoadBalancer (Cloud Provider)
- 중급편
  - 파드 <- Service (내부)
  - 파드 -> 파드 (내부)
  - 파드 -> Google (외부)
  - 사용자 접근은 서비스 IP, Port 등을 통해 접근 가능
    - 파드 동시 배포 상황 pod1 -> pod2 접근 해야 하는 상황 (파드 ip를 미리 알 수 없고, 파드 ip는 동적으로 변경된다.)
      - 즉 DNS, Headless 서비스가 필요하다.
    - Pod -> Github: 접근 주소 변경시 파드 경로 수정 후 재배포? XX
      - Service ExternalName을 이용해 Pod 수정 없이 외부 연결 변경 가능
  - K8s Cluster
    - 별도 DNS 서버 존재
      - 서비스 도메인 이름, IP 저장
    - pod -> 서비스 도메인 이름 질의 -> IP 알 수 있다.
      - (내부망) k8s DNS 서버에 없다면 DNS 메커니즘상 상위 DNS(내부망 DNS)에서 탐색 후 해당 이름 IP를 알 수 있다.
      - (외부망) 외부망 DNS (공식) -> K8s에서 Google을 찾는다면 k8s DNS를 찾고, 상위 NDS(외부 DNS)에서 탐색후 IP를 알아낸다.
  - 내부망
    - DNS 서버 구축 햇다고 가정
      - 내부 서버 이름, IP 저장
  - DNS 구성
    - K8s DNS -> 내부망 DNS -> 외부망 DNS
      - DNS 구성을 통해 원하는 서비스나 외부에 접근 가능하다.
  - Pod IP를 몰라도 k8s DNS 서버에 서비스 이름으로 IP를 물어봐서 연결
  - Pod를 선택해서 연결하고 싶을 땐 Headless 서비스 연결!
    - 파드에 헤드리스 서비스 연결 -> k8s DNS에 podname.servicename과 IP 등록된다.
  - External Name 서비스 생성
    - 특정 외부 도메인 주소를 넣을 수 있다. (google.com)
      - 상위 DNS를 호출해 IP를 알아낸다. (k8s DNS -> 내부망 DNS -> 외부망 DNS)
    - pod -> ExternalName(https://github.com/ItChoi/TechBlog)
      - 파드는 이 서비스를 통해 데이터를 가져오도록 설정 -> 추후 데이터 가져오는 경로 변경이 필요하면 파드 수정없이 서비스의 External Name만 수정하면 된다.
- Service - Headless 상세 설명
  - default namespace
    - Service1(10.11.4.10)
      - ClusterIP
    - Pod1(20.109.5.11)
    - Pod2(20.109.5.12)
    - 연결 구조
      - pod1 <- service1
      - pod2 <- service1
  - K8s DNS (cluster.local)
    - DNS 구조
      - Service | service1.default.svc.cluster.local       | 10.11.4.10
      - Pod     | 20-109-5-11.default.pod.cluster.local    | 20.109.5.11 
      - Pod     | 20-109-5-12.default.pod.cluster.local    | 20.109.5.12
      - Pod     | pod5.headless1.default.svc.cluster.local | 20.109.5.13
    - DNS 구조 살펴보기
      - FQDN (Fully Qualified Domain Name)
        - 서비스 도메인 이름은 서비스명만 입력해도 된다.
        - 파드는 모두 입력 (파드IP.네임스페이스.파드.DNS이름)
      - 서비스 도메인 이름
        - 서비스명.네임스페이스.서비스약어.DNS이름
          - 헤드리스 사용 서비스의 경우 서비스 IP가 없기 때문에 서비스 호출시 연결된 모든 파드의 IP를 준다. (ClusterIP: none)
      - 파드 도메인 이름
        - 파드IP.네임스페이스.파드.DNS이름
          - 앞 부분이 IP라서 거의 쓰지 않는다.
        - 파드호스트명.서비스명.네임스페이스.서비스약어.DNS이름
          - 헤드리스 사용 파드
    - 파드 -> 파드를 호출 할 일은 별로 없다 (파드 DNS 질의는 파드 IP를 알아야 한다.)
      - 서비스 이름만 알아도 서비스 접근 가능
      - 파드 -> 파드 연결 하기 위해서 Headless 서비스 구성 필요
  - Headless 서비스 생성 및 사용 방법
    - Service - ClusterIP 속성에 none 명시 -> 서비스 IP를 만들지 않는다. (내부적으로도 만들어지지 않는다.)
    - Pod - hostname 속성에 도메인 이름, subdomain 속성에 서비스명을 넣어야 한다.
- Service - Endpoint 상세 설명
  - 중요한 오브젝트! ExternalName 쉽게 이해 가능
  - Endpoint
    - 연결 구조
      - Service1(label:app1) - Pod1(label:app1, 20.109.5.11:8080)
      - Service1(label:app1) - Pod2(label:app1, 20.109.5.12:8080)
    - k8s 내부적으로 Endpoint가 생성되어 연결고리 관리
      - 서비스명으로 엔드포인트명 설정하고 파드 접속 정보를 넣는다. 
        - Service1
          - 20.109.5.11:8080 -> Pod1
          - 20.109.5.12:8080 -> Pod2
        - Label, Selector를 안 만들고 직접 연결도 가능하다.
          - Service2, Pod3(20.109.5.12:8080) (미연결 상태)
          - Endpoint 생성
            - 서비스명으로 네이밍, pod ip (port) 명시
          - 외부 IP 주소를 안다면, 외부 IP를 가리키게 할 수도 있다.
            - IP는 변경된다.
- Service - ExternalName 상세 설명
  - IP 변경 가능성이 있기 떄문에 도메인 이름을 쓴다 -> 도메인 이름 지정 - ExternalName 
  - Service에 ExternalName 속성 추가해 도메인 이름을 쓴다.
    - DNS Cache
      - DNS Cache가 내부, 외부 DNS를 찾아 IP를 알아낸다.
      - Service -> DNS Cache -> DNS (k8s)
      - Service -> DNS Cache -> External Network(DNS - github.com)
  