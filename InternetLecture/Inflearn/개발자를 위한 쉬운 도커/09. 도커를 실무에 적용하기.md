# 도커를 실무에 적용하기

## 파트 소개

## 레이어 관리
- 도커 파일 레이어 구조
  - Dockerfile 작성 지시어 하나당 레이어 하나 추가
    - 레이어가 추가되지 않는 지시어도 있지만, 일반적으로는 추가된다.
      - 추가되지 않는 레이어: CMD, ..
  - 불필요 레이어가 많아지면 이미지 크기가 늘어나고 빌드 속도가 느려진다.
- 대표적으로 RUN 지시어 사용을 관리!
  - RUN 지시어는 &&를 최대한 활용해 하나로 처리!
  - 불필요 명령어 추가로 레이어 개수 늘어나지 않게 주의
  - 5개 레이어 생성
    - RUN apt-get update
    - RUN apt-get install -y curl
    - RUN apt-get install -y xz-utils
    - RUN apt-get install -y git
    - RUN apt-get clean
  - 1개 레이어 생성으로 변환
    - 리눅스에서 &&를 통해 여러 명령어를 한 번에 실행
    - RUN apt-get update && RUN apt-get install -y curl && RUN apt-get install -y xz-utils && RUN apt-get install -y git && RUN apt-get clean
      - 레이어 합산 사이즈는 비슷하지만, 레이어가 1개 추가되느냐 5개 추가되느냐 차이가 있다.
- 이미지 크기는 작을수록 좋다.
  - 네트워크를 통해 업로드 & 다운로드 -> 이미지가 작을수록 배포 속도, 네트워크 사용량에 유리하다!
  - 이미지 크기 줄이는 방식은 여러 개가 있다.
    1. 앱의 사이즈를 줄인다. -> 모듈 분리, 불필요 코드 제거
        - 앱을 포함한 이미지의 크기도 줄어든다.
    2. 베이스 이미지는 가능한 작은 이미지 사용
       - alpine OS를 사용하는 것이 좋다.
       - 스크래치 이미지 -> 이미지의 뿌리, 이미지 빌드를 위한 최소한의 파일만 포함한 이미지
    3. .dockerignore
       - 불필요 파일이 이미지 안으로 들어가는 것을 방지
       - COPY . .
         - COPY 지시어를 여러 개 나누면 불필요 레이어가 늘어난다.
         - .dockerignore와 같이 활용
- 스크래치 이미지 활용 실습
  - git switch 02-practice
    - 실습 폴더 easydocker/build 이동 및 브랜치 변경
  - cd 05.go-scratch
    - 실습 폴더 easydocker/build/05.go-scratch 이동 및 브랜치 변경
  - docker build -t helloworld .
    - 이미지 빌드
  - docker run -d -p 8080:8080 --name go-helloworld helloworld
    - 컨테이너 실행

## 캐싱을 활용한 빌드
- 빌드 속도를 빠르게 만들어주는 기술
- 이미지를 빌드 한 후 다시 빌드 할 때 동일한 지시어를 사용하는 경우 이미지 레이어를 새롭게 만들지 않고, 캐시에 저장된 레이어를 그대로 사용한다.
  - 완전 동일 소스 코드로 이미지 재빌드 -> 빠르게 이미지 빌드 가능
  - 지시어를 똑같이 작성한 경우 캐시에 저장된 레이어를 그대로 사용!
    - 지시어로 처리하는 내용까지 같아야 동일한 것으로 본다.
  - COPY, ADD 명령은 빌드 컨텍스트의 파일 내용이 변경돼도 캐시 사용 못함!
  - 캐싱 가능한 곳 까지 캐싱하다가, 다른 곳 이후에는 캐싱을 사용하지 않는다.
- 레이어는 이전 레이어를 기반으로 새로운 레이어가 쌓인다.
  - 이전 레이어 변경시 -> 다음 레이어도 변경될 수 밖에 없다.
    - 캐싱 불가
- 잘 변경되지 않는 레이어를 잘 배치해서 캐시 활용 빈도를 높이는 것이 중요하다.
- 외부 라이브러리는 변경되는 일이 잦다.
  - COPY . . 
    - 라이브러리 변경 없이 기능만 추가되더라도, 외부 라이브러리까지 새롭게 수행된다.
    - 라이브러리 설치 부분 따로 분리 -> 캐싱 활용 극대화 가능
    - 예시
      - COPY package*.json ./ \n RUN npm ci \n COPY . .
        - 외부 라이브러리 파일과 설치를 별도로 분리하고 캐싱 활용
        - frontend
      - COPY build.gradle settings.gradle ./ \n RUN gradle dependencies --no-daemon \n COPY . .
        - backend
- 변경이 자주 일어나지 않는 부분을 초기에 세팅하고, 변경 빈도에 따라 적절하게 배치 -> 캐싱 할용 극대화!
  - 앱의 규모가 커질수록 캐시의 강력함을 알 수 있다.
- 명령어
  - docker build -t leafy-front:2.0.0 . --no-cache
    - 캐시를 사용하지 않고 빌드 테스트 -> 강제로 캐시 사용 X, 기존 캐시 사용을 방지
    - 60초 정도 걸림
  - docker build -t leafy-front:2.0.1 .
    - 위 명령어 빌드 후 캐시 사용한 빌드 테스트
    - 1초 정도 걸림
    - CACHED로 캐싱된 것 확인 가능
  - docker build -t leafy-front:2.0.2 .
    - 소스코드 텍스트 변경후 빌드 테스트
    - 캐시 사용하지 않고, 재빌드된다.

## 3Tier 아키텍처 구성
- 클라이언트 -> 백엔드 
  - 일반적으로 사용자가 직접 접근하지 않도록 설정하는 것이 유리하다.
  - nginx proxy를 이용해 직접 접근 제한 가능
- nginx 이미지 필요
  - nginx 서버 설정 변경 필요
    - location /api/ { proxy_pass http://leafy:8080; }
- 프록시
  - 특정 경로 -> 원하는 경로 전달
  - /api 경로 -> 백엔드 API로 전달 규칙
    - nginx 설정 추가 
- 명령어
  - docker build -t leafy-front:3.0.0-proxy .
  - docker network create leafy-network
  - docker run -d --name leafy-postgres -v mydata:/var/lib/postgresql/data --network leafy-network devwikirepo/leafy-postgres:1.0.0
  - docker run -d -e DB_URL=eafy-postgres --name leafy --network leafy-network devwikirepo/leafy-backend:1.0.0
  - docker run -d -p 80:80 --name leafy-front --network leafy-network leafy-front:3.0.0-proxy
  - docker rm -f leafy-postgres leafy leafy-front
  - docker volume rm mydata

## 동적 서버 구성
- 환경 별로 달라지는 정보는 시스템 환경 변수 처리!
  - 컨테이너 실행시 결정 가능
  - ex) nginx
    - location /api/ { proxy_pass http://${BACKEND_HOST}:${BACKEND_PORT} };
    - nginx 실행시 환경 변수 지정 
      - BACKEND_HOST = leafy-backend
      - BACKEND_PORT = 8080
  - 컨테이너 실행 전에 스크립트를 실행해 nginx.conf 수정 후 컨테이너 실행!
- 명령어
  - docker build -t leafy-front:4.0.0-env .
  - docker network create leafy-network
  - docker run -d --name leafy-postgres -v mydata:/var/lib/postgresql/data --network leafy-network devwikirepo/leafy-postgres:1.0.0
  - docker run -d -e DB_URL=leafy-postgres --name leafy-backend --network leafy-network devwikirepo/leafy-backend:1.0.0
  - docker run -d -e BACKEND_HOST=leafy-backend -p 80:80 --name leafy-front --network leafy-network leafy-front:4.0.0-env
  - docker exec leafy-front cat etc/nginx/conf.d/default.conf
  - docker rm -f leafy-postgres leafy-backend leafy-front

## PostgreSQL 이중화DB 구성

## 컨테이너 애플리케이션 최적화

## (Node.js, VSCode) 컨테이너 내부에서 개발환경 구성

## (JAVA, IntelliJ) 컨테이너 활용 및 원격 디버깅
