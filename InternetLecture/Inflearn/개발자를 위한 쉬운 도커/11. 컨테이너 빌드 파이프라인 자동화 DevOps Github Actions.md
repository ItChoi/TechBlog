# 컨테이너 빌드 파이프라인 자동화(DevOps, GitHub Actions)

## 파트 소개
- https://github.com/daintree-henry/leafy3
  - ci/cd 테스트 프로젝트
  - fork -> clone
## DevOps, CI/CD 파이프라인, GitHub Actions 개념
- DevOps
  - 개발, 운영 합성어
  - 개발자와 운영자의 간극을 줄이는 것
    - 컨테이너 도입으로 개발, 배포 환경의 차이를 줄인다.
    - CI/CD
    - 자동화
    - MSA
    - IaC
- 파이프라인
  - 물이 흐르는 관을 의미
  - 소스 코드가 흐른다 (자동화)
    - code push
    - build -> artifact
    - test
    - deploy -> 운영 환경 배포
    - test
  - CI/CD 파이프라인을 통해 위의 배포 과정 자동화 가능
    - CI 파이프라인
      - Continuous Integration
      - 지속적 통합
      - 배포 가능한 아티팩트(jar/image)를 빌드하는 단계
    - CD 파이프라인
      - Continuous Delivery/Deployment
      - 지속적 배포
      - 실제 환경에 아티팩트를 배포하는 단계
- Github Actions
  - 파이프라인 구성, 자동화 가능
  - code push -> github actions -> ci/cd 파이프라인 자동 실행 가능
  - pc, 별도 빌드용 서버 없이 파이프라인 실행 가능
    - github 빌드용 서버를 임시로 빌려준다
    - 한 달의 500M 공간, 2000분은 무료 사용 가능
  - 파이프라인 -> 소스코드 -> .github/workflows 폴더 안 yml
    - github이 자동으로 파이프라인으로 인식
  - 러너(Runner)
    - 워크플로우가 실제 실행되는 서버
    - 깃헙 무료 러너 또는 자신의 서버에서 직접 실행 가능
    - 모든 작업은 러너에서 실행 - yml
  - 워크플로우
    - 서버에서 실행되는 파이프라인의 실제 작업
      - 파이프라인과 동일하게 봐도 된다.
    - .github/workflows 디렉토리에 yml로 정의 (yml 파일 한개 -> 워크플로우)
    - Workflows(1)-(N)Jobs(1)-(N)Steps 
      - 워크플로우 파일 안에서 코드 형태로 작성되어 있다.
  - 트리거(Trigger)
    - 워크플로우를 자동으로 실행시켜주는 조건
      - push
      - 특정 요일 특정 시간
- 워크플로우 문법
  - yml 문법 사용
  - 크게 3가지 파트 구성
    - name -> 워크 플로우 이름 지정
    - on -> 트리거 설정
      - schedule -> 시간 트리거
        - cron: '0 0 * * *'
      - push -> 소스 코드 푸시 트리거 (여기까지만 있는 경우 -> 모든 변경 사항에 트리거 발동)
        - branches
          - develop -> 트리거될 특정 브랜치 지정
        - paths
          - 'module-backend/**' -> 트리거될 특정 폴더 지정 - 해당 경로 소스 변경시 트리거 발동
        - tags:
          - 'dev*' -> 트리거될 특정 태그, 커밋 메시지인듯? 세 가지 조건 and 조건 
    - jobs -> 파이프라인이 실제 실행하는 워크플로우 작업 작성
      - build-and-push -> job 여러 개 지정 가능
        - runs-on: ubuntu-latest -> 작업이 실제로 실행될 러너 지정
        - steps -> 작업에 해당하는 여러 개의 step 지정 가능
          - name: step-test -> 스텝명
          - uses: actions/checkout@v2 -> 소스 코드 다운, 빌드 - 소스코드를 러너에 다운 받는 작업, 깃헙에서 제공하는 스텝 -> checkout  
          - uses: docker/stepup-buildx-action@v1 -> 도커에서 제공하는 step, 러너에 기본적으로 도커는 설치되어 있지만 buildx는 설치되어 있지 않다. 활성화를 통해 멀티 플랫폼, 캐싱 기능 사용 가능  
          - uses: docker/login-action@v1 -> 이 경우 하위 with 사용, pc에서 도커 로그인과 동일 작업 
          - with:
            - username: ${{ secrets.DOCKERHUB_USERNAME }} -> hub사용자명, 시크릿 제공, git hub에 key, value 저장 필요
            - password: ${{ secrets.DOCKERHUB_TOKEN }} -> hub인증토큰, 시크릿 제공
          - uses: docker/build-push-action@v2 -> 이 경우 하위 with 사용, 소스코드를 사용해 이미지 빌드 및 레지스트리 푸시 
          - with:
            - context: 빌드컨텍스트
            - file: 도커파일위치
            - push: 이미지푸시여부
            - tags: 이미지태그
            - platforms: CPU아키텍처

## GitHub Actions를 활용한 이미지 빌드 자동화 파이프라인 구성
- github 인증 정보 세팅
  - settings -> developer settings -> personal access token -> tokens(classic)
- github secret -> key, value 지정
  - repository settings -> secrets and variables -> actions -> new repository secret -> key,value 입력
- docker-compose.yml
  - container.build
    - 도커 허브 이미지로만 실행할 때 삭제해도 된다.
    - Github Actions로 이미 이미지를 레지스트리에 push한 경우 없어도 된다.