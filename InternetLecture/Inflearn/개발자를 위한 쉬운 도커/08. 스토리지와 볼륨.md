# 스토리지와 볼륨

## 파트 소개
- 볼륨은 컨테이너에 상태를 갖게 만들어준다.
- 상태란?
- 마운트 개념
- 도커 볼륨 적용 - DB, 웹 서버

## 컨테이너의 상태(State)
- 컨테이너
  - 기본적으로 상태 없음(Stateless) -> 컨테이너 주요 특징
    - 저장 및 공유가 필요한 데이터 -> 무조건 외부에 저장
      - 데이터 영구 보관 -> 데이터베이스 서버 사용 
      - 세션 정보, 캐시 등 -> 캐시 서버나 쿠키 관리 필요
    - 동일한 요청 -> 동일한 결과 제공 필수
    - 환경 변수, 구성 파일 -> 설정 외부 주입 
      - 컨테이너 구성 -> 실행 시점에 메타 데이터 값을 조정해 컨테이너 구성! 
  - 이미지 -> 읽기 전용 레이어 -> 컨테이너 실행시 컨테이너 레이어 추가
    - 컨테이너 실행 후 발생하는 모든 변경 -> 컨테이너 레이어에 모두 쌓인다.
    - 컨테이너 삭제시 컨테이너 레이어도 함께 삭제된다.
    - 컨테이너 삭제는 물론 버전 업데이트 시에도 삭제 후 컨테이너 레이어가 새로 생성된다.
  - 컨테이너 이미지는 한 번 지정된 후 변경 X (불변성)
    - 새로운 변경 적용시 새 이미지를 만들어야 한다.
  - "old 컨테이너 -> new 컨테이너"로 언제든지 쉽게 대체 가능해야 한다.
    - 이미지만 있으면 환경 제약이 없다.
- Pet & Cattle
  - 전통적인 서버 관리 방법론 : Pet
    - 애완견을 의미
    - 서버 한 대를 소중 -> 한 대 한 대를 직접 관리
    - 서버 종료 -> 장애 - 주시, 관리 필요
    - 가상 머신 방식
    - 서버 상태 -> 서버 내부에 저장
  - 컨테이너 활용 방법론: Cattle
    - 가축을 의미
    - 서버는 소모품 -> 새로운 서버를 빠르게 실행, 기존 서버 대체
      - 서버가 Stateless해야 가능하다.
    - 컨테이너 방식
  - 클라우드 네이티브 구조에서 서버를 다루는 방법론
  - MSA 아키텍처 -> 서버 개수가 많아진다.
  - 상태 없음, 필요시 외부 마운트(볼륨)
- 명령어
  - echo Hello Volume! > index.html
  - cat index.html
  - docker run -d --name my-nginx nginx
  - docker cp index.html my-nginx:usr/share/nginx/html/index.html
  - docker rm -f my-nginx
  - docker run -d --name my-nginx nginx
    - index.html 체크 -> 변경사항 적용 확인 -> 적용 X
  - docker rm -f my-nginx
  - rm -rf index

## 도커 볼륨(Docker Volume)
- 컨테이너 -> Stateless(무상태)
  - 컨테이너 삭제, 재생성 -> 컨테이너 레이어 초기화 (데이터 모두 삭제)
  - 영속성 데이터 공간 필요
    - 도커 볼륨 기능 제공
    - 컨테이너 -> 마운트 -> 도커 볼륨
- 마운트
  - 외부 저장 공간을 컴퓨터의 특정 경로와 연결 가능
  - 외부 저장 공간은 물리적으로 연결하거나 네트워크에 연결할 수 있다.
  - 컨테이너의 특정 디렉터리에 볼륨을 마운트해서 사용!
  - 예시 -> USB
    - USB -> 물리적 연결 장치
    - USB 동일 역할 -> 네트워크 파일 시스템 (NFS)
      - 네트워크에만 연결되어 있으면 USB와 동일한 역할 수행 가능
- 도커 볼륨
  - 컨테이너의 특정 폴더를 공유 폴더로 만들 수 있다.
    - "컨테이너의 폴더를 볼륨에 마운트한다"라고 표현
  - USB처럼 데이터를 외부에 보관하는 기능 제공
  - 컨테이너들은 도커 볼륨을 컨테이너 특정 경로에 마운트해서 사용
    - 데이터 영구 사용 가능
    - 영구 데이터 공유 -> 동일 요청은 동일 결과 응답 가능
  - 컨테이너가 삭제 돼도 도커 볼륨과 그 안의 데이터는 삭제되지 않는다.
  - 하나의 도커 볼륨은 여러 컨테이너에서 공유 가능
- 도커 볼륨 생성
  - 볼륨 생성마다 Host OS 특정 공간에 데이터 저장 볼륨이 만들어진다.
  - 컨테이너에서 이 볼륨을 마운트해서 사용시, 데이터 저장시 Host OS의 볼륨 공간에 저장된다.
  - Host OS에 저장되는 볼륨 공간에 사용자가 직접 접근하기는 어렵다.
    - 도커가 경로를 자동으로 관리
    - 도커가 실행되는 가상 머신 안에서 저장
    - Host OS에서 데이터 직접 관찰이 필요한 경우 -> 바인드 마운트(Bind mounts) 기능 사용
  - 바인드 마운트(Bind mounts)
    - Host OS에서 실제 데이터가 저장되는 디렉터리를 사용자가 지정 가능
      - Host OS 디렉터리와 컨테이너 디렉터리를 직접 지정해서 마운트
    - 도커 볼륨이 만들어지지 않는다.
    - 바인드 마운트 보다 **볼륨을 통해 관리하는 것이 일반적**이다.
    - 직접 디렉터리 내용 관찰이 필요한 경우 유용하다.
- 명령어
  - docker -v 도커볼륨명:컨테이너의내부경로
    - 도커 볼륨을 컨테이너 디렉토리로 마운트
  - docker run -v 도커볼륨명:컨테이너의내부경로 -v 도커볼륨명:컨테이너의내부경로
    - 하나의 컨테이너에 여러 개의 볼륨 마운트 가능!
  - docker run -v 마운트할HOST_OS경로:컨테이너의내부경로
  - docker volume ls
  - docker volume inspect 볼륨명
  - docker volume create 볼륨명
  - docker volume rm 볼륨명
  - docker volume create mydata
  - docker volume inspect mydata
    - Driver: local
      - 실제 데이터가 Host OS에 저장된다는 것을 의미
      - mountpoint
        - 저장되는 실제 경로
        - 리눅스에서 해당 경로 관찰 가능
        - MacOs 등에서는 도커가 가상 머신 형태로 실행되어 실제 데이터 관찰 불가
  - docker run -d --name my-postgres -e POSTGRES_PASSWORD=password -v mydata:/var/lib/postgresql/data postgres:13
  - docker container inspect my-postgres
  - docker exec -it my-postgres psql -U postgres -c "CREATE DATABASE mydb;"
  - docker exec -it my-postgres psql -U postgres -c "\list"
  - docker rm -f my-postgres
  - docker run -d --name my-postgres-2 -e POSTGRES_PASSWORD=password -v mydata:/var/lib/postgresql/data postgres:13
  - docker exec -it my-postgres-2 psql -U postgres -c "\list"
  - docker rm -f my-postgres-2
  - docker volume rm mydata
  - docker run -d -p 8000:80 --name my-nginx-a -v HOST_OS경로:/usr/share/nginx/html nginx
  - docker run -d -p 8001:80 --name my-nginx-b -v HOST_OS경로:/usr/share/nginx/html nginx
  - docker volume ls 
    - 바인드 마운트 사용으로 실제 생성된 도커 볼륨은 없다.
  - echo Hello Volme! > index.html
    - host os에서 실행
  - docker exec -it my-nginx-a /bin/bash
  - ls /usr/share/nginx/html
  - echo Bye Volume! > /usr/share/nginx/html/index.html
    - 컨테이너에서 실행
