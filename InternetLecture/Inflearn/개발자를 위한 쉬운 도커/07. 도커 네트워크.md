# 도커 네트워크

## 파트 소개

## 네트워크 기본
- 네트워크
  - 기기간 정보를 주고받기 위한 통신망!
  - 전 세계 네트워크 신호는 ip 주소 체계를 사용해, 원하는 목적지로 찾아갈 수 있다.
  - 여러 장치들이 서로 연결되어 정보를 주고 받을 수 있는 시스템
  - 기계와 기계 사이를 랜선이라는 케이블로 물리적으로 연결한다.
    - 물리적인 케이블을 통해 전기 신호로 정보를 주고 받을 수 있다.
  - 전 세계 전자기기들은 물리적인 인터넷 선으로 연결되어 있고, 그물망처럼 촘촘히 짜여져있다. -> 네트워크
    - net + work
  - 네트워크 안에서 정보를 주고 받을 때 목적지 주소, 즉 ip가 필요하다.
    - 컴퓨터가 인터넷 연결 될 때, ip 주소를 할당받는다.
    - ip 주소
      - 8 byte 3개의 숫자 4개의 조합으로 만들어진 주소
      - 0.0.0.0 ~ 255.255.255.255 
        - 고유해야 하기 때문에 중복될 수 없다.
        - 조합 가능 개수 -> 43억개,
      - ip는 고정이 아니라 바뀔 수도 있다. 
      - ip 주소는 각 통신사가 관리한다.
      - 고정 ip를 받아서 사용 할 수 있지만, 가정용 ip는 일반적으로 동적 ip
      - 인터넷 가입시 회선당 하나의 ip를 할당받아 사용
      - ping 8.8.8.8
        - 상대방 서버에 응답이 있는지 확인하는 명령어
        - 8.8.8.8 
          - 미국 캘리포니아에 위치한 서버
          - 핑 성공 의미 -> 내 컴퓨터 인터넷 선에서 신호가 출발해 국내 네트워크망을 타고 미국으로 가는 해저 케이블을 타서 미국 네트워크망에 위치한 8.8.8.8 서버에 신호를 보내고 다시 돌아오는 것이다.
          - 신호가 다른 국가에 까지 전달되는 것은 네트워크 낭비! -> 국가 별로 여러 처리가 되어 있다.
            - 이론적으로 ip는 고유 주소를 나타내고, 실제 신호가 전달된다는 것을 알 수 있다.
- 인터넷 회선
  - 인터넷 회선당 공인 ip 하나씩 할당 -> 하나의 인터넷 회선으로 다양한 기기(폰, 노트북, ...)로 인터넷 사용 가능
    - 하나의 ip로 여러 기기 사용 -> 사설 ip 활용 필요!
- ip
  - 공인 ip
    - 집 주소 -> 전세계 유일
    - 공유기
      - 포트 구성
        - 인터넷 선 꼽기 가능 -> WAN 포트
          - 외부에서 들어오는 인터넷 신호를 연결해야 한다.
        - 각 기기 연결해 사설 IP 분배 -> LAN 포트
          - 연결시 사설 IP 할당 (TV, 컴퓨터, 스마트폰, ...)
          - 공유기같은 네트워크 장비 안에서만 고유한 IP 
    - 공인 IP에서 사설 IP로 나누기 위해 네트워크 장비 필요!
      - 가정 -> 공유기
    - 공인 IP 확인
      - 브라우저 -> 나의 ip 확인
  - 사설 ip
    - 방 번호 -> 특정 집 안에서 유일
    - 사설 IP 주소 대역
      - 10.0.0.0 - 10.255.255.255 (Class A)
      - 172.16.0.0 - 172.31.255.255 (Class B)
      - 192.168.0.0 - 192.168.255.255 (Class C)
        - 사설 IP로 가장 많이 사용하는 형식
    - 사설 IP 확인
      - 터미널 -> ifconfig
- IT 기업 인프라 환경
  - 공인망 (외부 네트워크를 사용한 통신망)
    - 공인 IP를 사내 서버로 분배해주는 라우터 장비 존재
    - 공유기와 비슷한 역할 수행, 기업 네트워크 환경은 더 복잡한 계층 구조로 되어 있다.
    - 실제 서버에 인터넷 선이 연결되고, 사설망 사설 IP 할당!
    - 기업 네트워크 레이어는 복잡하지만, 구조는 동일 
  - 사설망 (내부 네트워크 통신망)
- 네트워크의 인터페이스와 포트
  - 네트워크 인터페이스
    - 인터넷 연결을 위해 컴퓨터에 장착하는 부품 중 하나
    - ip를 가질 수 있다.
    - ip 할당받고 인터넷에 연결하려면 네트워크 장비와 랜선으로 연결되어 있어야 한다.
    - 무선 기능 지원 -> 랜선으로 연결하지 않고 와이파이에 연결하여 사용 가능
    - 하나의 기기는 한 개 이상의 네트워크 인터페이스 장착 가능
      - 노트북 -> 유선 인터페이스, 무선 인터페이스 두 개가 장착되어 있다.
      - 방에 들어가는 문이 여러 개가 있다고 생각하면 된다.
    - 서버에 네트워크 인터페이스가 장착되어 있고, 네트워크 인터페이스에 할당된 IP로 데이터를 주고 받는다.
      - 서버에는 여러 개의 소프트웨어 설치!
        - 특정 소프트 웨어로 지정해 데이터 전달 할 때 PortNumber가 필요하다.
          - port는 물리적으로 존재하지 않고, 서버 내에서 정의해서 사용한다.
            - 네트워크 사용 프로그램은 실행될 때 사용될 포트 지정 가능
              - 사전에 약속된 포트 -> Well-Known Port -> 80(http), 443(https), 22(ssh), 21(ftp)
              - 포트 직접 지정 가능
          - 192.168.0.5:80
          - 192.168.0.5:53
          - 192.168.0.5:3000
- 네트워크 통신
  - InBound
    - 출발지 -> 서버
    - 클라이언트, 외부에서 출발해서 자신의 서버로 오는 신호
  - OutBound 
    - 서버 -> 도착지
    - 서버에서 출발하는 신호
- NAT와 포트포워딩
  - NAT: Network Address Transration
  - 사설망을 구성하는 라우터 장비는 모두 NAT 기능을 갖는다.
  - 외부 서버, 내부서버 통신이 어떻게 이루어질까?
    - 외부 서버는 전세계 유일 공인 IP
    - 내부 서버는 사설망 안에서 식별 가능한 사설 IP
    - 외부 공인 IP <---> 내부 사설 IP 통신은?
      - NAT와 포트포워딩 기술을 사용한다.
        - 네트워크 신호를 보낼 때, 출발지와 목적지 정보가 있어야 한다.
        - 내부 서버 -> 외부 서버는 간단하다. 
          - 출발지: 사설 IP
          - 도착지: 외부 서버 공인 IP
        - 외부 서버 -> 내부 서버
          - 출발지: 외부 서버 공인 IP
          - 도착지: 내부 서버 상위 공인 IP
            - 내부 서버 IP로 어떻게 지정?
              - 이 때 NAT을 사용 -> 공인 IP와 사설 IP를 매핑해주는 기술
                - 공인 IP와 사설 IP 매핑 테이블을 만든다.
                  - 내부 서버 상위 공인 IP: 124.111.46.91 -> 공인 포트번호 10001 --- 사설 IP: 192.168.0.4 -> 사설 포트 번호: 80
                    - 10001 port -> 랜덤하게 정해진다.
                  - 내부 서버 상위 공인 IP: 124.111.46.91 -> 공인 포트번호 10002 --- 사설 IP: 192.168.0.5 -> 사설 포트 번호: 5432
                    - 10002 port -> 랜덤하게 정해진다.
                  - 내부 서버 -> 외부 서버 (OutBound)
                    - 출발지 124.111.46.91:10001
                    - 도착지 223.130.200.107
                    - 응답 (OutBound)
                      - 출발지 -> 도착지(요청시 ip:port 그대로 사용)
                  - 외부 서버 -> 내부 서버 (InBound)
                    - 출발지 223.130.200.107
                    - 도착지 124.111.46.91:10001
                      - 여러 방법 존재 
                        1. NAT 테이블 규칙에 맞게 자동으로 생성된 공인 포트번호(10001,10002)로 지정해서 사용
                           - 이 경우 랜덤한 공인 포트 번호를 사용하는 것 보단, 미리 포트 지정하는 것이 좋다.
                             - 미리 정의한다는 것은 80, 8080, 3000, 5432 등 Well-Known port를 의미
                           - NAT테이블은 동적으로 정보를 관리 -> 외부에서 서버를 접근 할 때 혼란이 생길 수 있다. 
                        2. 포트포워딩!
                           - 공인 IP 주소: 124.111.46.91 -> 공인 포트 번호: 80 --- 사설 IP 주소: 192.168.0.4 -> 사설 포트 번호: 80
                             - 외부 서버는 124.111.46.91:80로 요청 -> 192.168.0.4:80로 요청 전달
                           - 공인 IP 주소: 124.111.46.91 -> 공인 포트 번호: 21 --- 사설 IP 주소: 192.168.0.5 -> 사설 포트 번호: 20021
- DNS
  - Domain Name System
  - 도메인 주소와 ip 주소 매핑
  - nslookup google.com
    - 내 PC에서 사용하는 dns 서버 ip 주소 확인 가능, 변경 가능
    - 도메인 ip 확인 가능
  - 사내망 환경의 DNS 서버
    - 일반적으로 엔터프라이즈 환경에서는 사내망에서 DNS 서버를 별도 운영한다.
    - 도메인과 IP 주소 매핑은 같다.
    - 정보 주고 받는 주체가 사설망 내부 서버로 한정되어 사용한다.
    - 사내 서버끼리 도메인으로 통신 가능하도록 정보 제공
    - 사내 서버의 DNS 주소는 외부 DNS 서버가 아니라 내부 DNS 서버로 지정!
    - 공인 DNS 서버는, 공인 DNS간 동기화된다.

## 도커 가상네트워크 (1)
- 공인망, 사설망 모두 랜선과 서버를 물리적으로 관찰 가능하다.
- 컨테이너 가상화
  - 서버 한 대를 여러 컨테이너로 격리
- 도커는 가상 네트워크를 활용해 컨테이너를 구성한다.
- 가상 네트워크
  - 서버 한 대 안에서 여러 네트워크 구성
  - 네트워크 망 안에서 컨테이너간 통신 가능
  - 내부 컨테이너 <-> 바깥 서버 통신 가능
  - 물리적 인터넷 선, 공유기 없이 한 대의 서버 안에서 논리적으로 정의된 네트워크
- 도커 가상 네트워크
  - 도커 설치시 
    - 가상 네트워크 - 브릿지 네트워크 생성
    - 가상 공유기 - docker0(브릿지) 생성
      - 가상 IP 주소 할당 받는다 
        - 일반적으로 172.17.0.1
      - 컨테이너들에게 IP 할당
        - 172.17.0.2
        - 172.17.0.3
        - 172.17.0.4
      - 컨테이너간 통신 할 수 있도록 해준다.
  - 같은 가상 네트워크에서 생성된 컨테이너들은 네트워크를 통해 서로 통신 가능하다.
    - 172.17.0.2 -> 172.17.0.4
      - 브릿지를 거쳐 네트워크 패킷이 전달된다.
- SDN (Software Defined Network)
  - 논리적으로 네트워크 구성
  - 대부분 물리 네트워크 구조와 비슷하다.
- 가상 네트워크와 가상 인터페이스
  - 가상 네트워크 상에서 네트워크 신호 전달 프로세스
    - PC 위에서 도커 설치시 Host OS에 가상 인터페이스 생성
      - Host OS -> docker0(브릿지) 172.17.0.1
    - 도커 컨테이너 생성시 Host OS에 VethN라는 접두어로 생성된다.
      - Host OS -> Veth1 172.17.0.2, ...
      - N은 랜덤하게 고유한 번호가 할당, 1. 2. 3. 4 순서는 아니다.
    - 도커 컨테이너를 4개 만들었다고 했을 때, Host OS에 생성 
      - 물리 인터페이스 1개 - 공인 IP
      - 가상 인터페이스 5개 - Veth1,2,3,4 + docker0 - 사설 IP
      - Host OS의 Veth2 인터페이스에 전달된 네트워크 신호는 해당하는 컨테이너로 전달한다.
    - Veth1 -> Veth2 요청은?
      - 소프트웨어적으로 트래픽을 전달해야 한다.
      - 가상 인터페이스간 네트워크 패킷 전달 규칙은 Host OS의 커널 소프트웨어인 iptables에 정의된다.
        - iptables: Linux 내부 네트워크 트래픽 관리 및 제어
          - 도착지 172.17.0.3 -> Veth2 인터페이스로 전달
        - 컨테이너 1개당 Host 머신에 가상의 Veth 인터페이스 1개 생성
        - Docker가 iptables의 규칙을 수정하여 Veth 인터페이스의 트래픽 제어
      - 즉 도커는 컨테이너 생성, 삭제시 Host OS의 iptables 규칙을 업데이트 한다.
- 도커 가상 네트워크
  - 가상 네트워크 내부에서 여러 개의 브릿지 네트워크 관리 가능
  - 같은 네트워크 속한 컨테이너는 통신 가능, 즉 네트워크가 다른 컨테이너는 통신 불가하게 할 수 있다.
- 명령어
  - docker network ls
  - docker network inspect 네트워크명
  - docket network create 네트워크명
  - docker network rm 네트워크명
- 브릿지 1개 생성, 컨테이너 3개 생성 후 컨테이너간 통신 테스트
  - 브릿지1 -> 컨테이너 1, 2
  - 브릿지2 -> 컨테이너 3
- 도커 네트워크 bridge
  - 기본 브릿지 -> ip 범위 -> 172.17.0.1 ~ 172.17.255.255
  - 생성 브릿지 -> ip 대역 설정 가능 -> ex) 10.0.0.0 ~ 10.0.0.255
- 도커 네트워크
  - 기본적으로 세 개의 네트워크가 있다.
    1. bridge
    2. host
    3. none
  - Driver는 네트워크의 종류를 의미한다.
- 명령어
  - docket network inspect bridge
    - subnet -> 이 네트워크 안에서 생성되는 컨테이너들의 할당받는 ip 범위
    - gateway -> 도커 네트워크 ip 주소
  - docker network create --driver bridge --subnet 10.0.0.0/24 --gateway 10.0.0.1 second-bridge
    - terminal 1로 접근
  - docker run -d --name ubuntuA devwikirepo/pingbuntu
    - terminal 2로 접근
  - docker run -it --name ubuntuB devwikirepo/pingbuntu bin/bash
    - terminal 2로 접근
  - docker run -it --network second-bridge --name ubuntuC devwikirepo/pingbuntu bin/bash
    - terminal 3로 접근
  - 컨테이너 IP
    - ubuntuA: 172.17.0.2 - bridge
    - ubuntuB: 172.17.0.5 - bridge
    - ubuntuC: 10.0.0.2 - second-bridge
  - ping 172.17.0.2 
    - terminal 2로 접근
    - 컨테이너 쉘 - ubuntuB
    - 접근 성공
  - ping 10.0.0.2
    - terminal 2로 접근
    - 컨테이너 쉘 - ubuntuB
    - 접근 실패
  - docker rm -f ubuntuA ubuntuB ubuntuC
  - docker network rm second-bridge
- 컨테이너는 같은 브릿지에 속한 컨테이너끼리만 통신 가능하다.

## 도커 가상네트워크 (2)
- 도커 네트워크 포트포워딩
  - 가상 네트워크에서 컨테이너 실행시 컨테이너간 통신은 가능하다.
  - HostOS, 외부 서버에서 컨테이너 접근시 포트포워딩이 필요하다.
- 명령어
  - docker run -p HostOS의포트:컨테이너포트
    - -p: 포트포워딩 옵션
  - docker run -d --name nginx nginx
  - docker container inspect nginx
    - 172로 시작하는 컨테이너의 사설 IP를 브라우저 등으로 접근할 수 없다.
  - docker run -d -p 8001:80 --name nginx2 nginx
    - host os의 8001 포트를 컨테이너 80 포트와 매핑
  - docker run -d -p 8002:3000 --name redColorApp --env COLOR=red devwikirepo/envnodecolorapp
  - docker run -d -p 8003:3000 --name blueColorApp --env COLOR=blue devwikirepo/envnodecolorapp
  - ifconfig에서 나오는 사설 ip로, 같은 와이파이를 이용하는 기기로 접근 가능
    - 즉 핸드폰으로도 사설ip:8003 하면 같은 페이지를 볼 수 있다.
    - 하나의 공유기 공인 IP -> 사설망을 만들어 PC, mobile 모두 같은 공유기에 같은 대역대의 사설 IP를 할당 받아 서로 접속 가능!
  - docker run -d -p 8003:3000 --name yellowColorApp --env COLOR=yellow devwikirepo/envnodecolorapp
    - 8003 포트포워딩 -> 포트 충돌로 생성이 안 된다.
  - docker run -d -p 8004:3030 --name greenwColorApp --env COLOR=green devwikirepo/envnodecolorapp
    - 컨테이너 포트가 존재하지 않는 경우!
    - 컨테이너는 정상 실행, 브라우저에서 접근시 정상 응답 X
  - docker rm -f nginx nginx2 redColorApp blueColorApp yelloColorApp greenColorApp yellowColorApp
- 가상 네트워크와 DNS
  - 도커는 컨테이너들이 기본적으로 사용 할 수 있는 DNS 서버 제공
    - 컨테이너명:IPAddr
      - 컨테이너 이름으로 컨테이너간 통신 가능!
- 명령어
  - docker network create --driver bridge --subnet 10.0.0.0/24 second-bridge
    - 터미널1에서 실행
  - docker run -it --network second-bridge --name containerA devwikirepo/pingbuntu bin/bash
    - 터미널1에서 실행
    - cat /etc/resolv.conf
      - DNS 서버 주소 확인 가능
    - ping containerB
      - 에러 -> containerB 존재 X
  - docker run -d --network second-bridge --name containerB devwikirepo/pingbuntu
    - 터미널2에서 실행
  - docker rm -f containerB 
  - docker rm -f containerA
  - docker network rm second-bridge
- 도커 네트워크 종류
  - driver
    - 브릿지 네트워크(bridge): 도커 브릿지를 활용해 컨테이너간 통신, NAT, 포터포워딩 기술을 활용해 외부 통신 지원
      - 대부분 이걸 사용하면 된다.
    - 호스트 네트워크(Host): 호스트의 네트워크를 공유, 모든 컨테이너는 호스트 머신과 동일한 IP 사용, 포트 중복 불가능
    - 오버레이 네트워크(Overlay): k8s에서 사용, 호스트 머신이 다수일 때 네트워크 관리 기술
    - Macvlan 네트워크: 컨테이너에 MAC 주소를 할당하여 물리 네트워크 인터페이스에 직접 연결

## Leafy 네트워크
