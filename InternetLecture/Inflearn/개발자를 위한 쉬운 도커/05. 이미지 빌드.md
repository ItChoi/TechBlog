# 이미지 빌드

## 파트 소개

## 이미지와 레이어(Layer)
- 이미지
  - 컨테이너 실행을 위한 읽기 전용 파일
- 도커 이미지
  - 저장소를 효율적인 사용을 위해 레이어드 파일 시스템으로 구성!
    - 레이어는 층을 의미한다.
    - 레이어드 구조
      - 재사용에 유리하다.
      - 공간 효율 사용 가능
      - 이미지 전송 저장시 스토리지와 네트워크 사용량 절약 가능!
  - 각각의 레이어는 이미지의 일부!
- 이미지 레이어
  - 바로 직전 단계 레이어에서 변경된 내용들만 저장된다.
  - nginx 이미지 설계 단계
    - OS
    - Nginx 설치
    - Nginx 설정
    - Index.html 파일 수정
  - Nginx 이미지 레이어
    - 이미지 A
      1. OS 파일 시스템 레이어
      2. Nginx 설치 레이어 (설치 파일)
      3. Nginx 설정 레이어 (설정 파일 - nginx.conf)
      4. index.html 레이어 (index.html 파일)
    - 이미지 B
      - 1, 2, 3이 같고, 4번만 index.html 파일을 custom index로 내용 변경이라고 가정
      - 1 ~ 3은 같은 레이어 재사용, 마지막 레이어만 새롭게 추가되어 이미지 B가 완성!
      - 총 3개의 레이어를 공유하고 하나의 레이어를 별도로 사용하는 구조!
  - 설명
    - OS가 준비되고, OS 위에 Nginx 소프트웨어를 설치한다.
    - 소프트웨어 설치시 OS 특정 폴더에 Nginx 소프트웨어와 관련된 파일들이 추가된다.
    - Nginx 설치한다는 의미는 기존 OS 파일 시스템에서 **추가되는 부분이 생긴다**는 것!
    - 기존 레이어 수정이 아니라, 기존 레이어 위에 변경된 내용들이 새로운 레이어로 저장된다.
    - Nginx 설치 레이어에는 직전 레이어인 OS 레이어에서 Nginx 소프트웨어가 추가된 부분만 따로 가지고 있다.
    - 즉 이전 레이어와 비교해서, 추가되거나 변경된 파일들이 다음 레이어로 저장되는 것이다.
    - 이미지에서 한 번 저장된 레이어는 변경할 수 없다!
      - 변경 사항 존재시 새로운 레이어로 만들어야 한다.
  - 이미지 레이어로 컨테이너 실행!
    - docker run --name container1 ImageA
      - 이미지 가장 마지막 레이어 위에 새로운 읽기/쓰기 전용 레이어 추가! -> 컨테이너 레이어라 부른다.
      - 앱 로그, 컨테이너 실행 중 생기는 변경 사항 -> 새로운 레이어(컨테이너 레이어)에 저장된다.
      - 이미지 레이어는 수정 불가한 읽기 전용 레이어!
      - 이미지 레이어와 컨테이너 레이어는 역할이 완전 다르다!
        - 이미지 레이어 -> 컨테이너 실행을 위한 세이브 포인트
        - 컨테이너 레이어 -> 이미지를 컨테이너로 실행 후 프로세스 변경을 기록하는 레이어
    - docker run --name container2 ImageA
      - 이미지 레이어는 같다! 읽기 전용 레이어 공유
      - 새로운 컨테이너 레이어 하나만 추가된다.
    - 하나의 이미지로 아주 많은 컨테이너를 실행해도, 이미지 레이어는 공유한다!
    ![img.png](img.png)
- 명령어
  - docker image history 이미지명
    - 이미지의 레이어 이력 조회
  - docker image inspect 이미지명
    - inspect 출력 결과로 이미지 레이어의 해시 값도 포함되어 있다.
      - RootFs -> Type, Layers
    - 이미지 레이어는 고유 값을 갖고 있다.
- 이미지 레이어는 결과적으로 같은 내용이더라도 구성 순서가 다르면, 완전 다른 레이어로 구성된다.
- 도커 레이어드 파일 시스템
  - Layering
    - 중복 데이터 최소화
    - 빌드 속도 향상
    - 저장소 효율적 사용
  - Copy-on-Write(Cow) 전략
    - 해당 파일의 복사본을 만들어 변경 사항 적용
  - Immutable Layers (불변 레이어)
    - 이미지 일관성 유지
  - 캐싱
    - 빌드된 레이어 재사용
    - 이미지 생성 속도를 크게 절약 가능

## 이미지 커밋(Commit)
- 이미지를 만드는 두 가지 방법
  1. 커밋: 현재 컨테이너 상태를 이미지로 저장
  2. 빌드: Dockerfile을 통해 이미지 저장 (대부분 사용, 그러나 커밋 기반 동작)
- 이미지 커밋
  1. Nginx 이미지를 컨테이너로 실행
  2. index.html 수정
  3. image run -> 컨테이너 레이어(읽기, 쓰기) 생성
     - 이미지 원래 파일을 컨테이너 레이어에 COPY, 수정된 파일 내용을 write
  4. 도커 commit을 통해 컨테이너 레이어, 이미지 레이어 모든 레이어를 이미지로 저장!
- 명령어
  - docker run -it --name 컨테이너명 이미지명 bin/bash
    - 컨테이너 실행과 동시에 터미널 접속
    - -it: 커맨드 창을 통해 실행할 컨테이너와 직접 상호작용 가능
  - docker commit -m 커밋명 실행중인컨테이너명 생성할이미지명
    - 실행 중인 컨테이너를 이미지로 생성
- 예시
  - docker commit -m "edited index.html" -c 'CMD ["nginx", "-g", "daemon off;"]' officialNginx itchoi0429/commitnginx
  - docker run -d -p 80:80 --name my-nginx itchoi0429/commitnginx
  - docker push itchoi0429/commitnginx


## 이미지 빌드(Build)

## 빌드 컨텍스트(Build Context)

## 도커파일(Dockerfile) 지시어

## 멀티 스테이지 빌드(Multi-Stage Build)
