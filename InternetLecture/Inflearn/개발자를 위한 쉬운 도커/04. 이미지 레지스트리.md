# 이미지 레지스트리

## 파트 소개
- 필요한 이미지를 다운 받거나, 이미지를 저장해 공유 가능
- 이미지 네이밍 규칙 존재 

## 이미지 레지스트리
- 많은 제품의 이미지가 있다.
- 이미지 공유 (다운로드, 업로드)
- 이미지 검색 가능
- 이미지 버전 관리 가능 (원하는 사용자만 다운로드 가능하도록 인증 및 권한)
- 보안 (안전한 이미지 다운로드 가능하도록 보안)
- 파이프라인 (이미지 업로드시 자동 배포 연계 및 알림 기능)
- 이미지 저장 공간 크게 3가지 분류
  1. Host 머신 로컬 스토리지 -> 도커 실행 호스트 OS의 특정 폴더
  2. 온라인 저장소 - private 레지스트리
  3. 온라인 저장소 - public 레지스트리
- docker run 명령어 입력시
  1. 로컬 스토리지에서 이미지 검색 -> 이미지 존재시 바로 실행
  2. 호스트 외부에 온라인 레지스트리에서 이미지 다운로드
  3. 컨테이너 실행 및 로컬 스토리지에 이미지 다운로드
  4. 동일 이미지는 온라인 레지스트리 검색 x, 로컬 스토리지에서 찾아서 실행
- 온라인 레지스트리
  - private
    - 특정한 네트워크에만 접근 가능
    - 사내망 레지스트리 
    - 직접 서버에 레지스트리 설치 후 사용 (HARBOR, DOCKER)
      - 사용자가 직접 서버에 설치
    - 퍼블릭 클라우드 서비스 사용 -> (AWS ECR, AZURE ECR)
      - 시간당 사용 요금 지불
  - public
    - 모든 네트워크에서 접근 가능
    - docker hub 레지스트리
- 이미지 네이밍 규칙
  - 이미지를 어디서 다운받고, 어떤 버전을 다운 받는지 모두 포함되어 있어야 한다.
    - 생략 가능 -> 디폴트 값이 있다.
  - 레지스트리주소/프로젝트명/이미지명:이미지태그
    - 레지스트리주소
      - 생략시 기본값, 도커 사용시 docker.io
    - 프로젝트명
      - 이미지 보관 폴더 개념
      - 레지스트리마다 프로젝트 정의 방식이 다를 수 있다.
        - 도커 허브 사용시 계정명이 프로젝트명이 된다.
    - 이미지명
      - 다운 받을 이미지명
    - 이미지 태그
      - 이미지 버전
      - 숫자와 영문 모두 사용 가능
  - 예시
    - devwiki.com/myProject/myNginx:2.1.0-alpine
      - 레즈스트리: devwiki.com
      - 프로젝트명: myProject
      - 이미지명: myNginx
      - 이미지태그: 2.1.0-alpine
    - devwikirepo/tencounter
      - 레지스트리 생략 -> docker.io
      - 프로젝트명 -> devwikirepo
      - 이미지명 -> tencounter
      - 이미지 태그 -> :latest 기본 값 (최신)
    - nginx
      - 도커는 도커사가 직접 검증한 이미지 -> 오피셜 이미지 제공
        - 라이브러리라는 프로젝트에서 관리!
      - 프로젝트명 생략한 이미지 -> 라이브러리가 기본 값으로 적용된다.
        - 즉 도커사가 직접 검증한 공식 이미지명을 다운 받는다.

## 이미지 레지스트리 실습
- 도커 허브 가입
- 이미지 검색
  - nginx
    - 맨 위에 뜨는 것이 라이브러리 프로젝트에서 제공하는 도커 오피셜 이미지
  - 라벨
    - docker official image
      - 도커가 직접 검증한 이미지
    - verified publisher
      - 도커가 직접 검증 x, 규모가 있는 회사에서 자체적으로 인증한 이미지 (좀 더 신뢰성)
    - tags - stable
      - 안정적인 버전
    - alpine
      - 베이스 이미지의 OS 버전 
- 도커 허브 이미지레지스트리
  - 기본적으로 무료 사용 가능
    - 특정 ip 6시간 100번 다운 가능
    - 로그인 유저 6시간에 200번 다운 가능
    - 하나의 계정당 하루 5000번의 다운로드 제한이 있다.
- 도커 레지스트리 실습
  - docker pull 이미지명
    - 로컬 스토리지로 이미지 다운로드
  - docker tag 기존이미지명 추가할이미지명
    - 로컬스토리지의 이미지명 추가
    - 새로운 이미지명을 만드는 명령어
    - 이미지의 프로젝트명을 바꾸기 위해서 바꾼다.
    - 기존 이미지를 베이스로해서 신규 프로젝트명과 이미지명을 만들어 푸시해야 개인용 레지스트리로 푸시 가능!
    - 베이스 이미지, 신규 이미지 -> 이미지 id가 같다 -> 실제 파일은 하나만 있다.
      - 이미지명에 따라 업로드되는 곳이 달라진다.
  - docker push 이미지명
    - 이미지 레지스트리에 이미지 업로드
- 실습
  - docker pull devwikirepo/simple-web:1.0
  - docker push itchoi0429/my-simple-web:0.1
    - 인증 관련 에러 발생!, 웹에는 로그인이 되어 있지만, 터미널에 도커 허브 계정 정보가 없다. 
      - denied: requested access to the resource is denied
      - 이미지 다운 받을 땐 권한이 없어도 되지만, push 할 땐 업로드할 계정의 인증 정보가 필요하다.
  - docker login
    - 이미지 레지스트리 인증 정보 생성
    - 스토리지의 특정 공간에 인증 정보가 생성
      - 인증 정보 생성은 os마다 다를 수 있다.
      - ~/.docker/config.json 파일로 저정된다.
  - docker logout
    - 이미지 레지스트리 인증 정보 삭제
  - docker image rm 이미지명
    - 로컬 스토리지의 이미지 삭제