# 목차
- 1파트 쿠버네티스 빠르게 훑어보기 (3장)
  - 3.1 쿠버네티스 내부의 네트워크 트래픽 라우팅
  - 3.2 파드와 파드 간 통신
  - 3.3 외부 트래픽을 파드로 전달하기
  - 3.4 쿠버네티스 클러스터 외부로 트래픽 전달하기
  - 3.5 쿠버네티스 서비스의 해소 과정

# 서론
파드는 k8s에서 앱 구성 기본 요소다.  
대부분의 앱은 여러 개 구성 요소로 나뉘는데, k8s는 파드 형태로 모델링한다. (백, 프론트 또는 MSA)  
모든 파드는 서로 통신 가능해야 한다. k8s는 표준 네트워크 프로토콜 TCP, UDP를 지원한다.  
두 프로토콜은 IP 주소로 트래픽을 제어하는데, 파드가 대체될 때 IP 주소가 변경되는 문제가 있다.  
K8s는 **서비스**에 **어드레스 디스커버리** 기능을 제공하여 해결했다.  
  
서비스는 파드들의 통신 트래픽 라우팅을 맡는 리소스다.  
통신 트래픽은 외부 -> 파드 전달, 파드 -> 외부 두 가지를 모두 포함한다.  
  
서비스 설정을 통해 시스템 구성 요소를 결합해보자.  

# 3.1 쿠버네티스 내부의 네트워크 트래픽 라우팅
- 복습 두 가지
  1. 파드는 k8s에서 부여한 ip를 갖는 가상환경이다.
  2. 파드는 컨트롤러 객체에 의해 생애주기가 관리되는 리소스다.
  
파드간 IP 통신시 문제가 있다.  
파드 교체시 IP 주소는 바뀌어 찾을 수 없다.  
새 IP 주소는 K8s API를 통해서만 파악이 가능하다.  
- 실습
  - 파드는 서로 통신 가능하다.
  - 먼저 서로 IP를 알아내야 한다.
  - cd ch03
  - kubectl apply -f sleep/sleep1.yaml -f sleep/sleep2.yaml
    - 각각 파드 하나 실행하는 디플로이먼트 두 개 생성
  - kubectl wait --for=condition=Ready pod -l app=sleep-2
    - 파드가 완전 시작 할 때 까지 대기
  - kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}'
    - 파드 IP 확인
  - kubectl exec deploy/sleep-1 -- ping -c 2 $(kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}')
    - 파드간 ping
  
파드간 통신이 가능했지만, ping 사용시 kubectl에서 IP 주소를 찾아야 한다.  
  
k8s가 만든 가상 네트워크는 클러스터 전체를 커버한다.  
IP 주소만 있따면 파드간 통신이 가능하다는 뜻이다.  
그러나 일반적인 파드간 통신 방법이 아니다.  
앞서 얘기했듯 파드 대체시 가상 IP 주소는 바뀐다.  
- 실습
  - 컨트롤러 객체인 디플로이먼트는 파드를 관리한다.
  - 파드 삭제시 새로운 파드가 생성되며 IP 주소는 변경된다.
  - kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}'
    - kubectl get pod sleep-1-8f68bd59d-c69l2 -o jsonpath='{.items[0].status.podIP}'
      - 이건 왜 출력이 안 될까?
      - 라벨을 통해 가져오면, 관련된 파드들을 배열로 가져오고, 파드를 지정했을 땐 배열이 아니라 출력 형식이 다르다.
        - kubectl get pod sleep-1-8f68bd59d-c69l2 --output jsonpath='{.status.podIP}'
  - kubectl delete pods -l app=sleep-2
  - kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}'
  
IP 주소가 변경됨에 따라 동작되던 것이 동작되지 않을 수 있다.  
파드는 삭제 되기 전 까지 고정 IP를 갖고 있지만, 대체 안 된다는 보장이 없다.  
k8s에서 DNS와 같은 해결책을 도입했다.  
즉 K8s 클러스터에 전용 DNS 서버가 있다. -> 서비스 이름과 IP 주소 매핑  

파드간 통신은 IP가 아니라, 도메인 이름을 통해 한다.
p.105 다이어그램부터


# 3.2 파드와 파드 간 통신

# 3.3 외부 트래픽을 파드로 전달하기

# 3.4 쿠버네티스 클러스터 외부로 트래픽 전달하기

# 3.5 쿠버네티스 서비스의 해소 과정


# 해당 파트 사용 명령어 모음
- kubectl apply -f sleep/sleep1.yaml -f sleep/sleep2.yaml
- kubectl wait --for=condition=Ready pod -l app=sleep-2
- kubectl get pod -l app=sleep-2 output jsonpath='{.items[0].status.podIP}'
- kubectl exec deploy/sleep-1 -- ping -c 2 $(kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}')
- kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}'
- kubectl delete pods -l app=sleep-2
- kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}'