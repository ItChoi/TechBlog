# 10.1 복제 소개
실제 서비스 운영시 단일 mongod 서버를 사용하면 매우 위험하다.  
한 서버 고장 등의 사유로 이용 불가 상태시 서비스 이용을 위한 대처가 어려워진다.  
복제를 통해 동일 데이터의 복사본을 여러 서버상에서 보관하는 것이 실제 서비스 배포시 권장된다.  
  
몽고 DB 사용시 '복제 셋'을 생성하여 복제 설정이 가능하다.  
복제 셋은 클라이언트의 요청 처리를 담당하는 프라이머리 서버, 프라이머리 서버 데이터 복사본을 갖는 세컨더리 서버 여러 대로 구성된다.  
프라이머리 서버 고장시, 세컨더리 서버 중 프라이머리 서버를 선출 할 수 있다.  
또한 데이터 접근을 세컨더리 서버로 접근 할 수 있고, 세컨더리 서버를 통해 새로운 복제 데이터를 만들 수도 있다.  
  
몽고 DB 클라우드 솔루션 '아틀라스' 사용 또는 자체 인프라에서 몽고 DB 클라우드 관리시 '옵스 매니저' 사용  
  
# 10.2 복제 셋 설정 - 1장
- docker exec -it mongodb /bin/bash
- mkdir -p ~/data/rs{1,2,3}
- mongod --replSet mdbDefGuide --dbpath ~/data/rs1 --port 27017 \ --smallfiles --oplogSize 200
- mongod --replSet mdbDefGuide --dbpath ~/data/rs2 --port 27017 \ --smallfiles --oplogSize 200
- mongod --replSet mdbDefGuide --dbpath ~/data/rs3 --port 27017 \ --smallfiles --oplogSize 200
- 3개 각각 mongod 프로세스 실행 필요

# 10.3 네트워크 고려 사항
복제 셋의 모든 멤버는 같은 셋 내 다른 멤버와 연결 할 수 있어야 한다.
mongod는 기본적으로 로컬호스트에만 바인딩된다.  
복제 셋의 멤버간 통신을 위해 IP 주소 바인딩 필요  
- 예시
  - 198.51.100.1 네트워크 인터페이스 서버에서 mongod 인스턴스 실행중
    - 멤버간 통신을 위해 명령행 매개변수 --bind_ip 지정 또는 구성 파일에 bind_ip 사용
      - 다른 mongod 시작시
        - mongod --bind_ip localhost,192.51.100.1 --replSet mbDefGuide \ --dbpath ~/data/rs1 --port 27017 --smallfiles --oplogSize 200

# 10.4 보안 고려 사항
복제 셋 구성 할 때 IP 주소 바인딩 전 권할 제어, 인증, 디스크 데이터 암호화, 통신 암호화 등을 하는 것이 좋다.  
  
# 10.5 복제 셋 설정 - 2장
각 mongod는 다른 mongod 존재를 모른다.  
각 멤버를 나열하는 configuration을 만들어야 한다.  

# 10.6 복제 관찰
  
# 10.7 복제 셋 구성 변경
복제 셋 구성은 언제든지 변경 가능하다.  
  
# 10.8 복제 셋 설계 방법
복제 셋 설계 전 '과반수' 개념을 이해하고 있어야 한다.  
프라이머리 선출시 멤버 과반수 이상이 필요하다.  
과반수 이상이어야 자격 유지, 쓰기 복제에 안전해진다.  
예를 들어 복제 셋에 멤버 5개, 그 중 3개가 다운 됐을 때 과반수에 미치지 않으므로 프라이머리 선출 불가  
이 상태면 두 개의 세컨더리와 세개의 통신이 안되는 멤버로 구성된다.  
세 개의 다운이 완전히 다운이 아니라, 네트워크가 다운 됐을 수도 있다.  
  
프라이머리를 하나만 갖도록 셋을 구성하는 것이 중요하다.  
다중 마스터는 그 자체로 복잡성을 수반한다. 쓰기 충돌 처리 필요  

## 10.8.1 어떻게 선출하는가
세컨더리가 프라이머리가 되지 못하면, 이를 멤버들에게 알리고 프라이머리 선출을 요청한다.  
세컨더리 중 복제 데이터가 최신이고, 우선순위가 높은 것을 선출한다.  
우선순위가 가장 높은 멤버가 프라이머리가 될 때 까지 계속 선출을 호출한다.  
  
# 10.9 멤버 구성 옵션
  
## 10.9.1 우선순위
멤버의 우선순위를 0으로 지정시 절대 프라이머리가 되지 않는다.  
  
## 10.9.2 숨겨진 멤버
요청을 라우팅 하지 않고, 복제 소스로 바람직하지 않다.  
  
## 10.9.3 아비터 선출
  
## 10.9.4 인덱스 구축
세컨더리는 프라이머리와 동일 인덱스를 갖지 않아도 된다.  










