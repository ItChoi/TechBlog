몽고DB는 강력하고, 진입장벽이 낮다.  
- 데이터 기본 단위는 도큐먼트이다. (RDBMS 행 = 도큐먼트)
- 컬렉션은 동적 스키마가 없는 테이블과 같다.
- 모든 도큐먼트는 컬렉션 내 고유 특수키인 "_id"를 갖는다.
- 몽고 쉘이라는 간단하지만 강력한 도구와 함께 배포
- 등등등

# 2.1 도큐먼트
몽고DB의 핵심은 정렬된 키, 연결된 값의 집합 -> 도큐먼트다.  
도큐먼트 표현 방식은 개발 언어마다 다르지만 대부분 map, hash, dictionary 등 자연스럽게 표현 가능한 자료구조를 갖는다.  
ex) 자바스크립트에서 도큐먼트는 객체로 표현한다.  

```mongodb-json
{
  "greeting" : "Hello, world!",
  "views" : 3
}
```
- key: "greeting"
  - key 중복은 안 된다.
- value: "Hello, world!"
- 복잡한 다중 키/값 쌍을 갖는다.
- 도큐먼트의 값은 blob형만 갖지 않고 데이터형이어야 한다.
  
- 몽고 DB는 데이터 타입, 대소문자를 구별한다.
  - {"count" : 5}, {"count" : "5"}
    - 다르다.
  - {"Count" : 5}, {"count" : 5}
    - 다르다.
  
# 2.2 컬렉션
도큐먼트의 모음을 컬렉션이라 한다.  
"도큐먼트 -> 행", "컬렉션 -> 테이블" 이라고 볼 수 있다.  

## 2.2.1 동적 스키마
컬렉션(테이블)은 동적 스키마를 갖는다.  
하나의 컬렉션(테이블) 내 도큐먼트(행)이 모두 다른 구조를 가질 수 있다.  
```mongodb-json
{"greeting" :  "Hello, world!", "views" :  3}
{"signoff" : "Good night, and good luck"}
```
- 도큐먼트의 key, key 개수, 데이터 타입 모두 다르다.
  - 테이블 내 데이터 행이 모두 다르다는 것
- 그럼 별도 컬렉션은 왜 필요할까?
  - 같은 컬렉션에 다른 종류 도큐먼트 저장시 번거로워진다. 예를 들면 쿼리 데이터 중 특정 데이터만 제거하려면 번거롭다.
  - 컬렉션 별 목록 추출시 특정 테이터 형 별로 목록 추출보다 훨씬 빠르다.
    - 컬렉션 내 특정 도큐먼트 key를 갖고 찾는 것 보단, 여러 컬렉션에서 올바른 컬렉션 쿼리하는 편이 훨씬 빠르다.
      - 한 컬렉션 (요약, 전체, 뚱뚱이) -> type 키를 통해 찾는 것 보다, 세 컬렉션을 두고 올바른 컬렉션 쿼리가 빠르다.
  - 같은 종류 데이터를 하나의 컬렉션에 모아두면 데이터 지역성에 좋다.
    - 게시물, 저자 정보가 섞인 컬렉션 보다 분리되어 있을 때 '게시물'만 뽑을 때 디스크 탐색 시간이 더 짧다.
  - 인덱스 생성시 도큐먼트는 특정 구조를 가져야 한다. (고유 인덱스인 경우 특히 더)
    - 인덱스는 컬렉션 별로 정의

## 2.2.2 네이밍
컬렉션은 이름으로 식별된다.  
어떤 UTF-8 문자열이든 사용 가능하지만 몇 가지 제약사항이 있다.  
1. 빈 문자열은 못 쓴다.
2. \0(null 문자)는 못 쓴다.
3. 시스템 컬렉션에서 사용하는 예약어는 못 쓴다. (system. ~)
4. 예약어 $를 못 쓴다.
  
- 서브컬렉션
  - 서브 컬렉션의 네임스페이스에 '.' (마침표)를 사용해 컬렉션을 체계화
    - blog.posts, blog.authors 두 컬렉션 사용
  - 쳬게화를 위한 것, 자식 부모관계는 아니다.

# 2.3 데이터베이스
컬렉션에 도큐먼트를 그룹화하는 것 뿐만 아니라, 데이터베이스에 컬렉션을 그룹 짓는다.  
몽고 DB 단일 인스턴스는 여러 DB에 호스팅 가능하다.  
하나의 몽고 DB 서버에서 여러 애플리케이션, 여러 사용자 데이터 저장시 유용하다. (회원, 상품, ...) 맞나?  
  
- 직접 접근 불가, 특별한 의미론을 갖는 예약된 데이터베이스 이름
  - admin
    - 인증, 인가
  - local
  
- config
  - 샤딩된 몽고 DB 클러스터는 config 데이터베이스를 사용해 각 샤드 정보 저장
  
cms DB의 blog.posts 컬렉션 사용시 네임스페이스는 cms.blog.posts다.  

# 2.4 몽고 DB 시작
- 유닉스 명령행 환경에서 mongod 실행 파일 실행
- 인수 없이 실행 시 기본 데이터 디렉터리로 '/data/db'를 사용한다.
- 기본적으로 27017 포트에서 소켓 연결을 기다린다.
  - 포트 사용 불가시 서버 시작 안 됌
  
# 2.5 몽고DB 셸 소개
몽고DB는 명령행에서 상호작용 가능한 자바스크립트 셸을 제공한다.  
셸은 관리 기능, 실행 중 인스턴스 점검, 간단 기능 시험에 매우 유용하다.  

## 2.5.1 셸 실행
mongo를 실행해 셸을 시작한다.  
셸 시작시 자동으로 로컬 장비에서 실행 중인 몽고DB 서버로 접속을 시도한다.  
따라서 시작 전, mongod 시작 했는지 선행 체크 필요  
  
셸은 완전한 자바스크립트 해석기이다.
- 기본적인 연산
  - x = 200;
  - x / 5;
- 표준 자바스크립트 라이브러리의 모든 기능 활용 가능
  - Math.sin(Math.PI / 2);
  - new Date("2019/1/1");
  - "Hello, World!".replace("World", "MongoDB");
- 자바스크립트 함수 정의 후 호출도 가능하다.
  ```javascript
  function factorial (n) {
    if (n <= 1) return 1;
    return n * factorial(n - 1);
  }
  
  factorial(5);
  ```
- 셸은 자바스크립트 구문이 완료됐는지 감지하여 엔터키 처리가 다르다.

## 2.5.2 몽고DB 클라이언트
셸은 시작 할 때, 몽고DB 서버의 test DB에 연결하고, DB 연결을 전역 변수 db에 할당한다.  
셸은 전역 변수에 할당한 변수를 활용해 몽고DB에 접근한다.  
'db' 명령 입력시 데이트베이스 확인 가능  
  
- 데이터베이스 선택 명령어
  - use video
- 자바스크립트 셸로써 변수 이름은 표현식으로 평가된다.
- db 변수에서 컬렉션으로 접근
  - db.movies

### 2.5.3 셸 기본 작업
- 셸에서 데이터 CRUD 가능.
- 생성
  - insertOne 함수를 통해 컬렉션에 도큐먼트를 추가한다.
  ```javascript
  movie = {
      "title" : "Star Wars: Episode IV - A New Hope",
      "director" : "George Lucas",
      "year" : 1977
  }

  db.movies.insertOne(movie);
  ```
  
- 조회
  - db.movies.find().pretty()
  - "_id" 키가 추가 됐다.
  - find, findOne 두 함수를 통해 컬렉션에 쿼리한다.
    - 쿼리 도큐먼트 형태로 조건 전달도 가능하다. -> 쿼리 일치 도큐먼트 결과로 제한
    - 셸은 일치 도큐먼트 20개까지 자동으로 출력, 그 이상도 가져올 수 있다.
  - 단일 도큐먼트 읽을 땐, findOne을 사용
  ```javascript
  db.movies.findOne()
  ```
  
- 갱신
  - updateOne 함수 사용
  - 매개변수는 최소 두 개 이상이다.
    1. 수정할 도큐먼트 찾는 기준
    2. 갱신 작업 설명 도큐먼트
  - 요구사항 -> 리뷰 기능 추가
    - 도큐먼트에 새 키 값 추가
    - 갱신시 갱신 연산자 'set' 이용
    ```javascript
    db.movies.updateOne(
        {title : "Star Wars: Episode IV - A New Hope"},
        {$set: {reviews: []}}
    )
    ``` 
  
- 삭제
  - deleteOne, deleteMany 함수를 통해 영구적으로 삭제한다.
    - 필터 도큐먼트로 삭제 조건 지정
  - 영화 도큐먼트 삭제
  ```javascript
  db.movies.deleteOne(
    {
        title : "Star Wars: Episode IV - A New Hope"
    }
  )
  ```
  
# 2.6 데이터형
더 다양한 시도를 해보자.  
몽고DB는 도큐먼트의 값으로 다양한 데이터형을 지원한다.  

## 2.6.1 기본 데이터형
몽고DB에서 도큐먼트는 json과 닮은 형태로 보일 수 있다.  
JSON은 데이터의 여섯 가지 데이터형만 열거하는 간단한 표현이다.  
- null, boolean, number, string, array, object
간단하지만서도 표현력의 제한이 있다.  
  
JSON은 날짜형도 없고 숫자형 타입은 하나다. 부동소수점 표현 방식은 없고 32bit, 64bit도 구별되지 않는다.  
몽고DB는 JSON의 key/value 형태를 유지하면서 추가적인 데이터형을 지원한다.  
  
- 몽고DB 데이터형
  1. null
     - {"x" : null}
  2. 불리언
     - {"x" : true}
  3. 숫자
    - {"x" : 3.14}
    - {"x" : 3}
    - {"x" : NumberInt("3")}
    - {"x" : NumberLong("3")}
  4. 문자열
     - {"x" : "foobar"}
  5. 날짜
    - {"x" : new Date()}
  6. 정규 표현식
     - {"x" : /foobar/i}
     - 자바스크립트의 정규 표현식 문법 사용가능
  7. 배열
     - {"x" : ["a", "b", "c"]}
     - 값의 Set, List를 배열로 표현 가능
  8. 내장 도큐먼트
     - {"x" : {"foo" : "bar"}}
     - 부모 도큐먼트의 값으로 내장된 도큐먼트 전체 포함 가능
  9. 객체 ID
     - {"x" : ObjectId()}
     - 객체 ID는 도큐먼트용 12바이트 ID
  10. 이진 데이터
     - 임의의 바이트 문자열
     - 셸로 조작 불가
  11. 코드
     - {"x" : function() { /* ... */ }}
     - 쿼리, 코드는 임의의 자바스크립트 코드 포함 가능
  12. 내부적으로 흔히 사용되는 몇 가지 타입이 더 있다. 등등등

## 2.6.2 날짜
자바스크립태 Date 클래스를 사용한다. -> new Date() 호출  
함수 호출시 실제 Date 객체가 아닌 날짜 문자열을 반환한다. -> 자바스크립트 방식  
따라서 날짜 사용시 뒤죽박죽이 되지 않도록 주의해야 한다.  

## 2.6.3 배열
List, Stack, Queue, Set 등 호환성 있게 사용 가능하다.  
- {"things" : ["pie", 3.14]}
  - 배열 안에 값은 서로 다른 데이터형을 포함할 수 있다.
  
도큐먼트 내 배열의 장점은 몽고DB가 배열의 구조를 '이해'한다는 점이다.  
배열에 쿼리를 날릴 수도 있고, 배열 내용을 이용해 인덱스를 만들 수 있다.  
몽고DB는 3.14가 "things" 배열의 요소인 모든 도큐먼트를 쿼리한다.  
자주 쓴다면 things key를 인덱스로 생성하여 쿼리 속도를 향상시킬 수 있다.  
  
몽고DB는 배열 내부에 도달해 값 수정도 가능하다. (pie -> pi 수정 등)  

## 2.6.4 내장 도큐먼트

